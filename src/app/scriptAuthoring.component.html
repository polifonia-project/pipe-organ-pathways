<p>Manage your Deep Viewpoints scripts.</p>
<div>
    <!-- <div *ngIf="viewScript=='0'">
        <span>Show:</span><br/>
        <span>
            <span class="mr-3"><input type="checkbox" [checked]="showOpenScripts" (change)="showOpenScripts = !showOpenScripts"/><label class="ml-2"> Open </label></span>
            <span class="mr-3"><input type="checkbox" [checked]="showClosedScripts" (change)="showClosedScripts = !showClosedScripts"/><label class="ml-2"> Closed </label></span>
        </span>
    </div> -->
    <div class="col-xs-12 mb-3 mt-2">
        <button class="float-right btn btn-success" *ngIf="viewScript=='0'" (click)="addScript(); deleteConfirmation_Id=''">Add new script</button><br/>
    </div>
    <div class="col-xs-12 ml-1 mr-1" *ngFor="let script of getScripts(); let i = index">
        <div *ngIf="((script.open && showOpenScripts) || (!(script.open) && showClosedScripts)) && (viewScript == '0' || viewScript==script._id)" class="border">
            <div *ngIf="editScriptDescription!=script._id" class="col-xs-12">
                <div  class="col-xs-8  mr-5 left">
                    <span  class="font-weight-bold">{{script.name}}</span>
                </div>
            </div>
            <div class="col-xs-4 float-right">
                <span *ngIf="viewScript=='0'">
                    <button class="mr-5 btn btn-info" (click)="viewScript=script._id; deleteConfirmation_Id=''">View</button>
                    <button class="btn btn-danger" (click)="confirmDelete(script._id)">Delete</button>
                </span>
                <span *ngIf="viewScript==script._id && editScriptDescription=='0' && editScriptStage==0">
                    <button class="btn btn-info" (click)="viewScript='0'; deleteStageConfirmationId=0; showStageHelp=false;">Return to list of scripts</button>
                </span>
            </div>
            <div class="col-xs-12">
                <!-- show script description --> 
                <span *ngIf="editScriptDescription!=script._id">
                    <span class="font-weight-bold">
                        Author: 
                    </span>
                    <span>
                        {{script.author}}
                    </span>
                    <br/>

                    <span class="font-weight-bold">
                        Themes: 
                    </span>
                    <span *ngFor="let theme of getThemesFromIds(script.themeids); let last = last">
                            {{theme.name}}<span *ngIf="!last">, </span>
                    </span>
                    <br/>

                    <span *ngIf="!getArtworksFromIds(script.artworkids).length" class="font-weight-bold">
                        Artworks: 
                    </span>
                    <table>
                    <tr *ngFor="let artwork of getArtworksFromIds(script.artworkids); let first = first">
                            <td><span *ngIf="first" class="font-weight-bold">Artworks:</span></td><td>{{artwork.name}}, {{artwork.artist}}, {{artwork.year}}</td>
                    </tr>
                    </table>
                    <span class="font-weight-bold">
                        Homepage artwork: 
                    </span>
                    <span *ngFor="let artwork of getArtworkFromId(script.homepageartworkid);">
                        {{artwork.name}}, {{artwork.artist}}, {{artwork.year}}
                    </span><br/>

                    <!-- <span *ngFor="let artwork of getArtworkFromId(script.artworkid);">
                        <span class="font-weight-bold">
                            Artwork: 
                        </span>
                        <span>
                            <span *ngIf="artwork">
                                <span *ngIf="artwork.name && artwork.artist && artwork.year">
                                    {{artwork.name}}, {{artwork.artist}}, {{artwork.year}}
                                </span>
                            </span>
                        </span><br/>     
                    </span> -->
                    <span class="font-weight-bold">
                        Status: 
                    </span>
                    <span *ngIf="script.open">Open</span>
                    <span *ngIf="!script.open">Closed</span><br/>
                    <span class="font-weight-bold">
                        Visibility: 
                    </span>
                    <span *ngIf="script.visible">Public</span>
                    <span *ngIf="!script.visible">Private</span><br/>
                    <span *ngIf="viewScript==script._id && editScriptDescription=='0' && editScriptStage==0">
                        <button class="btn btn-secondary" (click)="editScriptDescription=script._id; editScriptStage=0; deleteStageConfirmationId=0; showStageHelp=false;">Edit description</button><br/>
                    </span>
                    <span *ngIf="viewScript=='0'">
                        <span *ngIf="deleteConfirmation_Id==script._id">
                            <div class="alert alert-danger" role="alert"><strong>Are you sure you want to delete this script?</strong> <span><button class="btn btn-danger ml-2" (click)="deleteScript(script._id)">OK</button> <button class="btn btn-secondary ml-2" (click)="deleteConfirmation_Id=''">Cancel</button></span></div>
                        </span>
                    </span>
                    <div class="border" *ngIf="viewScript==script._id">
                        <span class="font-weight-bold">Stages</span><br/>
                        <span *ngIf="stagesOfAScript(script)==0">
                            <span>Add suggested stages: 
                                <button class="btn btn-success mr-1" (click)="addDefaultStagesToScript(script);">Add suggested stages to new script</button>
                            </span><br/>
                        </span>
                        <span *ngIf="editScriptStage==0">Add new stage: <button class="btn btn-success mr-1" (click)="addWelcomeStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">welcome</button> <button class="btn btn-success mr-1" (click)="addContextStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">context</button> <button class="btn btn-success mr-1" (click)="addQuestionStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">question</button> <button class="btn btn-success mr-1" (click)="addMultiQuestionStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">multiquestion</button> <button class="btn btn-success mr-1" (click)="addShareWithMuseumStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">shareWithMuseum</button> <button class="btn btn-success mr-1" (click)="addFollowStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">follow</button> <button class="btn btn-success mr-1" (click)="addShareWithSomeoneStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">shareWithSomeone</button> <button class="btn btn-success mr-1" (click)="addThankyouStageToScript(script); deleteStageConfirmationId=0; showStageHelp=false;">thankyou</button></span><span><img class="ml-3" width="20" style="background-color:white;" src="assets/img/question-help.png" (click)="toggleStageHelp()">
                        <br/>
                        <span *ngIf="showStageHelp">
                            <span class="font-weight-bold">welcome: </span><span>Add a welcome message introducing the activity</span><br/>
                            <span class="font-weight-bold">context: </span><span>Provide information or a perspective</span><br/>
                            <span class="font-weight-bold">question: </span><span>Ask a question and optionally provide a help prompt</span><br/>
                            <span class="font-weight-bold">multiquestion: </span><span>Add a number of questions which can be reloaded at random or shown in sequence</span><br/>
                            <span class="font-weight-bold">shareWithMuseum: </span><span>Give the option to share responses with the museum</span><br/>
                            <span class="font-weight-bold">follow: </span><span>Give the option to get a message when their response is published</span><br/>
                            <span class="font-weight-bold">shareWithSomeone: </span><span>Give the option to send the response to a friend or relation</span><br/>
                            <span class="font-weight-bold">thankyou: </span><span>Give a thankyou message for completing the activity</span><br/>
                        </span>
                        </span>
                        
                    </div>
                </span>

                <!-- edit script description -->
                <table *ngIf="editScriptDescription==script._id" width=100% class="border"><th></th><th></th>
                    <tr><td class="align-top">
                        <!-- script name -->
                        <span class="font-weight-bold">Title: </span>
                    </td><td>
                    <textarea rows="1" class="form-control" [(ngModel)]="script.name"></textarea>
                    </td></tr>
                    <tr><td class="align-top">
                        <span class="font-weight-bold">Themes: </span>
                    </td><td>
                        <span *ngFor="let theme of getThemes()" class="mr-3">
                            <input
                            type="checkbox"
                            [value]=theme._id
                            [ngModel] = "script.themeids.includes(theme._id)"
                            (change) = "themesChange(script, theme._id, $event)"
                            />
                            <label class="form-check-label"> {{theme.name}} </label>
                        </span><br/>
                        <span *ngIf="!getThemesFromIds(script.themeids).length" class="text-warning">At least one theme must be selected</span>
                    </td></tr>
                    <tr>
                        <td class="align-top">
                            <span class="font-weight-bold">Author: </span>
                        </td>
                        <td>
                            <textarea rows="1" class="form-control" [(ngModel)]="script.author"></textarea>
                        </td> 
                    </tr>
                    <tr><td  class="align-top">
                        <span class="font-weight-bold">Artworks: </span>
                    </td><td>
                        <span *ngFor="let artwork of getArtworks()" class="mr-3">
                            <input
                            type="checkbox"
                            [value]=artwork._id
                            [ngModel] = "script.artworkids.includes(artwork._id)"
                            (change) = "artworksChange(script, artwork._id, $event)"
                            />
                            <!-- <input
                            type="radio"
                            [value]="artwork._id"
                            name="artwork.name"
                            [(ngModel)] = "script.artworkid"
                            /> -->
                            <label class="form-check-label"> {{artwork.name}}, {{artwork.artist}}, {{artwork.year}} </label>
                            <br/>
                        </span>
                        <span *ngIf="!getArtworksFromIds(script.artworkids).length" class="text-warning">At least one artwork must be selected</span>
                    </td></tr>

                    <tr><td  class="align-top">
                        <span class="font-weight-bold">Homepage artwork: </span>
                    </td><td>
                        <span *ngFor="let artwork of getArtworksFromIds(script.artworkids)" class="mr-3">
                            <input
                            type="radio"
                            [value]="artwork._id"
                            name="artwork.name"
                            [(ngModel)] = "script.homepageartworkid"
                            />
                            <label class="form-check-label"> {{artwork.name}}, {{artwork.artist}}, {{artwork.year}} </label>
                            <br/>
                        </span>
                        <span *ngIf="script.homepageartworkid==undefined" class="text-warning">An artwork for the homepage must be selected</span>
                    </td></tr>


                    <tr><td class="align-top">
                        <!-- script status -->
                        <span class="mr-3 font-weight-bold">
                            Status: 
                        </span>
                    </td><td>
                        <span class="mr-3">
                            <input
                            type="radio"
                            [value]=true
                            name="open"
                            [(ngModel)] = "script.open"
                            checked
                            />
                            <label class="form-check-label"> Open </label>
                        </span>
                        <span class="mr-3">
                            <input
                                type="radio"
                                [value]=false
                                name="open"
                                [(ngModel)] = "script.open"
                            />
                            <label class="form-check-label"> Closed </label>
                        </span> 
                    </td></tr>
                    <tr><td class="align-top">
                        <!-- script visibility -->
                        <span class="mr-3 font-weight-bold">
                            Visibility: 
                        </span>
                    </td><td>
                        <span class="mr-3">
                            <input
                                type="radio"
                                [value]=true
                                name="visible"
                                [(ngModel)] = "script.visible"
                                checked
                            />
                            <label class="form-check-label"> Public </label>
                        </span>
                        <span class="mr-3">
                            <input
                                type="radio"
                                [value]=false
                                name="visible"
                                [(ngModel)] = "script.visible"
                            />
                            <label class="form-check-label"> Private </label>
                        </span>
                    </td></tr><tr><td colspan="2">
                        <button class="btn btn-success" (click)="editScriptDescription='0'; saveScript(script)" [disabled]="!getThemesFromIds(script.themeids).length || !getArtworksFromIds(script.artworkids).length || script.homepageartworkid==undefined">Done</button> 
                    </td></tr>
                </table>
            
                <span *ngIf="viewScript==script._id">
                   <!-- stages of selected scriptid -->
                    <div *ngFor="let stage of script.stages; let i = index" class="border">
                        <!-- show script stage -->
                        <span *ngIf="stage.id!=editScriptStage"> 
                            <span class="font-weight-bold">Type: </span><span>{{stage.stagetype}}</span><br/>
                            <span class="font-weight-bold">Position: </span><span>{{i+1}}</span><br/>
                            <span class="font-weight-bold">Title: </span><span>{{stage.title}}</span><br/>

                            <span *ngIf="!getArtworksFromIds(stage.includeartworks).length" class="font-weight-bold">
                                Show artworks: 
                            </span>
                            <table>
                            <tr *ngFor="let artwork of getArtworksFromIds(stage.includeartworks); let first = first">
                                    <td><span *ngIf="first" class="font-weight-bold">Show artworks:</span></td><td>{{artwork.name}}, {{artwork.artist}}, {{artwork.year}}</td>
                            </tr>
                            </table>


                            <span *ngIf='stage.stagetype=="multiquestion"'>
                                <span class="font-weight-bold">Style: </span>
                                <span *ngIf='stage.sequential'>Questions presented in sequence</span>
                                <span *ngIf='!stage.sequential'>Random question that can be reloaded</span>
                                <br/>
                            </span>
                            <span *ngIf='stage.stagetype=="multiquestion"'>
                                <span *ngFor="let question of stage.body; let i=index" class="mr-3">
                                    <span class="font-weight-bold">Text {{i+1}} : </span><span style="white-space: pre-wrap;" [innerHTML]="question"></span><br/>
                                </span>
                            </span>
                            <span *ngIf='stage.stagetype!=="multiquestion"'>
                                <span class="font-weight-bold">Text: </span><span style="white-space: pre-wrap;" [innerHTML]="stage.body"></span><br/>
                            </span>
                            <span *ngIf='stage.stagetype=="question"'>
                                <span class="font-weight-bold">Help text: </span><span style="white-space: pre-wrap;">{{stage.help}}</span><br/>
                            </span>
                            <span *ngIf="editScriptStage==0 && editScriptDescription=='0'"> 
                                <button class="mr-5 btn btn-secondary" (click)="editScriptStage=stage.id; deleteStageConfirmationId=0; showStageHelp=false;">Edit stage</button>
                                <button class="btn btn-danger" (click)="confirmStageDelete(stage.id); showStageHelp=false;">Delete stage</button><br/>
                            </span>
                            <span *ngIf="deleteStageConfirmationId==stage.id">
                                <div class="alert alert-danger" role="alert"><strong>Are you sure you want to delete this stage?</strong> <span><button class="btn btn-danger ml-2" (click)="deleteStage(script, stage); deleteStageConfirmationId=0; showStageHelp=false;">OK</button> <button class="btn btn-secondary ml-2" (click)="deleteStageConfirmationId=0; showStageHelp=false;">Cancel</button></span></div>
                            </span>
                        </span>
                        <!-- edit script stage -->
                        <span *ngIf="stage.id==editScriptStage">

                            <table width=100%><th></th><th></th>
                            <tr><td>
                                <span class="font-weight-bold">Type:</span>
                            </td><td>
                                <span>{{stage.stagetype}}</span>
                            </td></tr>
                            <tr><td>
                                <span class="font-weight-bold">Position:</span>
                            </td><td>
                                <select (change)="shiftStagePosition(script, $event, i); editScriptStage=0">
                                    <option *ngFor="let pos of script.stages; let ind = index" [selected]="ind==i" value="{{ind}}">   
                                        {{ind+1}}           
                                    </option> 
                                </select>
                                <!-- <textarea rows="1" class="form-control" [(ngModel)]="stage.title"></textarea> -->
                            </td></tr>
                            <tr><td>
                                <span class="font-weight-bold">Title:</span>
                            </td><td>
                                <textarea rows="1" class="form-control" [(ngModel)]="stage.title"></textarea>
                            </td></tr>
                            <tr>
                                <td class="align-top">
                                    <span class="font-weight-bold">Show artworks: </span>
                                </td>
                                <td>
                                    <span *ngFor="let artwork of getArtworksFromIds(script.artworkids)" class="mr-3">
                                        <input
                                        type="checkbox"
                                        [value]=artwork._id
                                        [ngModel] = "stage.includeartworks.includes(artwork._id)"
                                        (change) = "includeArtworksChange(script, stage, artwork._id, $event)"
                                        />
                                        <label class="form-check-label ml-1"> {{artwork.name}}, {{artwork.artist}}, {{artwork.year}} </label>
                                        <br/>
                                    </span>
                                </td>
                            </tr>
                            <tr *ngIf='stage.stagetype=="multiquestion"'>
                                <td class="align-top"><span class="font-weight-bold">Style: </span></td>
                                <td>
                                    <input
                                    type="radio"
                                    [value]=true
                                    name="sequential"
                                    [(ngModel)] = "stage.sequential"
                                    />
                                    <label class="form-check-label ml-1">Questions presented in sequence</label><br/>
                                    <input
                                    type="radio"
                                    [value]=false
                                    name="sequential"
                                    [(ngModel)] = "stage.sequential"
                                    />
                                    <label class="form-check-label ml-1">Random question that can be reloaded</label><br/>
                                </td>
                            </tr>
                            <tr><td class="align-top">
                                <span class="font-weight-bold">Text:</span>
                            </td><td>
                                <span *ngIf='stage.stagetype!="multiquestion"'>
                                    <textarea rows="3" class="form-control" [(ngModel)]="stage.body"></textarea>
                                </span>
                                <span *ngIf='stage.stagetype=="multiquestion"'>

                                    <span *ngFor="let q of stage.body; let index=index; trackBy:trackByIdx" class="mr-3">
                                        <span class="font-weight-bold">Question {{index+1}}: </span><br/><textarea rows="3" class="form-control" [(ngModel)]="stage.body[index]"></textarea>
                                    </span>
                                </span>
                            </td></tr>
                            <tr *ngIf='stage.stagetype=="question"'><td>
                                <span class="font-weight-bold">Help text:</span>
                            </td><td>
                                <textarea rows="3" class="form-control" [(ngModel)]="stage.help"></textarea>
                            </td></tr>
                            <tr><td></td><td><button class="btn btn-success mr-3" (click)='stage.body = stage.body.concat("Question goes here")'>Add new question</button>    <button class="float-right btn btn-danger" (click)="stage.body.splice(stage.body.length -1)" [disabled]="stage.body.length <= 2">Delete last question</button></td></tr>
                            </table>
                            <span>
                                <button class="btn btn-success" (click)="editScriptStage=0; saveScript(script)">Done</button><br/>
                            </span>
                        </span>
                    </div>
                </span>
            </div>
        </div>
    </div><br/>
</div>